___
# 四元组
TCP 四元组可以唯一的确定一个连接，四元组包括如下：
* 源地址
* 源端口
* 目的地址
* 目的端口

![[Pasted image 20230521224540.png]]

源地址和目的地址的字段（32位）是在 IP 头部中，作用是通过 IP 协议发送报文给对方主机。
源端口和目的端口的字段（16位）是在 TCP 头部中，作用是告诉 TCP 协议应该把报文发给哪个进程。

> **注意， TCP 头部只有端口没有 IP 地址，TCP 协议作为 IP 协议的上一层， IP 内部包含了 TCP 数据，所以 IP 地址信息在 IP 协议头部。数据传输过程中，通过 IP 协议找到目标机器，目标机器对数据包拆包得到 TCP 数据包，所以 TCP 头部是不需要 IP 地址的，只需要端口来决定处理数据的进程**

> 根据上面可知，一个连接是由一个四元组决定的，四元组其中的一个不一样，那么就是完全不一样的两个连接

___
# TCP 连接上限
由上面得到的，不同的四元组是完全不同的连接，那么我们的机器最大可以建立多少个连接呢？
作为客户端我们可以发出多少个连接？
有一个 IP 的服务器监听了一个端口，它的 TCP 的最大连接数是多少？

# 客户端
对于客户端的单个 IP 而言，请求同一个服务器的 IP 和端口，比如 x.x.x.x:8080
由于端口只有 65535 个，所以理论上只能维持 65535 个连接

如果客户端有多个网卡，每个网卡的 IP 不同，那么请求同一个服务器的 IP 和端口，就可以有
理论连接数 = IP 数 × 65535

当然，客户端端最大并发 TCP 连接数远不能达到理论上限。
* 首先主要是文件描述符限制，Socket 都是文件，所以首先要通过 ulimit 配置文件描述符的数目；
* 另一个是内存限制，每个 TCP 连接都要占用一定内存，操作系统是有限的。

所以机器能维持的连接数量，完全取决于硬件能力。

# 服务端
对于服务端的单个 IP 端口而言
对 IPv4，客户端的 IP 数最多为 2 的 32 次方，客户端的端口数最多为 2 的 16 次方，也就是服务端单机最大 TCP 连接数，约为 2 的 48 次方。
理论连接数 = 客户端的 IP 数量 × 客户端端口数量

同样的，和客户端一样，服务端最大并发 TCP 连接数远不能达到理论上限。

> 服务端能维持的 TCP 连接数，和端口数量 65535 完全没有关系，


